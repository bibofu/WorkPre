## 第1章：MySQL架构与历史

MySQL最重要、最与众不同的是他的存储引擎架构，这种架构将查询处理(Query Processing)及其他系统任务(Server Task)和数据的存储/提取相分离。。这种处理和存储分离的设计可以在使用时根据性能、特性，以及其他需求来选择数据存储的方式。

本章概要地描述了 MySQL 的服务器架构、各种存储引擎之间的主要区别，以及这些区别的重要性。

### MySQL 逻辑架构

MySQL服务器逻辑架构图：

![](https://s3.bmp.ovh/imgs/2022/02/5fc08b612f051e07.png)

![](https://s3.bmp.ovh/imgs/2022/02/04f1690028d6f81c.png)



#### 连接管理与安全性

每个客户端连接都会在服务器进程中拥有一个线程，这个连接的查询只会在这个单独的线程中执行，该线程只能轮流在某个 CPU 核心或者 CPU 中运行。服务器会负责缓存线程，因此不需要为每一个新建的连接创建或者销毁线程

MySQL 5.5 或者更新的版本提供了一个 API, 支持线程池 (Thread-Pooling) 插件，可以使用池中少量的线程来服务大量的连接。

当客户端（应用）连接到 MySQL 服务器时，服务器需要对其进行认证。认证基于用户名、原始主机信息、密码



#### 优化与执行

MySQL 会解析查询，井创建内部数据结构（解析树），然后对其进行各种优化，包括重写查询、决定表的读取顺序，以及选择合适的索引等。用户可以通过特殊的关键字提示(hint) 优化器，影响它的决策过程。也可以请求优化器解释 (explain) 优化过程的各个因素，使用户可以知道服务器是如何进行优化决策的

对于 SELECT 语句，在解析查询之前，服务器会先检查查询缓存 (Query Cache) , 如果能够在其中找到对应的查询，服务器就不必再执行查询解析、优化和执行的整个过程，而是直接返回查询缓存中的结果集。



### 并发控制

无论何时，只要有多个查询需要在同一时刻修改数据，都会产生并发控制的问题。本章的目的是讨论 MySQL 在两个层面的并发控制：==服务器层与存储引擎层==。

#### 读写锁

![](https://s3.bmp.ovh/imgs/2022/02/7ae2f6805b29896a.png)



这里先不讨论锁的具体实现，描述一下锁的概念如下：读锁是共享的，或者说是相互不阻塞的。多个客户在同一时刻可以同时读取同一个资源，而互不千扰。写锁则是排他的，也就是说一个写锁会阻塞其他的写锁和读锁，这是出千安全策略的考虑，只有这样，才能确保在给定的时间里，只有一个用户能执行写入，并防止其他用户读取正在写入的同一资源。

在实际的数据库系统中，每时每刻都在发生锁定，当某个用户在修改某一部分数据时，MySQL 会通过锁定防止其他用户读取同一数据。大多数时候， MySQL 锁的内部管理都是透明的。



#### 锁粒度

一种提高共享资源并发性的方式就是让锁定对象更有选择性。尽量只锁定需要修改的部分数据，而不是所有的资源。更理想的方式是，只对会修改的数据片进行精确的锁定。任何时候，在给定的资源上，锁定的数据量越少，则系统的并发程度越高，只要相互之间不发生冲突即可。

所谓的锁策略，就是在锁的开销和数据的安全性之间寻求平衡，这种平衡当然也会影响到性能。大多数商业数据库系统没有提供更多的选择，一般都是在表上施加行级锁 (row level lock), 并以各种复杂的方式来实现，以便在锁比较多的情况下尽可能地提供更好的性能。

MySQL 则提供了多种选择。每种 MySQL 存储引擎都可以实现自己的锁策略和锁粒度。在存储引擎的设计中，锁管理是个非常重要的决定。将锁粒度固定在某个级别，可以为某些特定的应用场景提供更好的性能，但同时却会失去对另外一些应用场景的良好支持。好在 MySQL 支持多个存储引擎的架构，所以不需要单一的通用解决方案。下面将介绍两种最重要的锁策略。



##### 表锁(table lock)

![](https://s3.bmp.ovh/imgs/2022/02/6c217f3378c4d623.png)



##### 行锁(row lock)

![](https://s3.bmp.ovh/imgs/2022/02/fb3356172fab33e5.png)



### 事务

事务就是一组原子性的 SQL 查询，或者说一个独立的工作单元。如果数据库引擎能够成功地对数据库应用该组查询的全部语旬，那么就执行该组查询。如果其中有任何一条语旬因为崩溃或其他原因无法执行，那么所有的语句都不会执行。也就是说，事务内的语句，要么全部执行成功，要么全部执行失败。

ACID 表示原子性(atomicity) 、一致性 (consistency) 、隔离性 (isolation) 和持久性 (durability) 。一个运行良好的事务处理系统，必须具备这些标准特征。

![](https://s3.bmp.ovh/imgs/2022/02/4dd240d995295381.png)



#### 隔离级别

隔离性其实比想象的要复杂。在 SQL 标准中定义了四种隔离级别，每一种级别都规定了一个事务中所做的修改，哪些在事务内和事务间是可见的，哪些是不可见的。较低级别的隔离通常可以执行更高的并发，系统的开销也更低。

下面简单地介绍一下四种隔离级别：

